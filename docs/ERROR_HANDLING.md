# Sistema de Manejo de Errores y Monitoreo - API V2

## üìã √çndice

- [Introducci√≥n](#introducci√≥n)
- [Arquitectura del Sistema](#arquitectura-del-sistema)
- [Middlewares Implementados](#middlewares-implementados)
- [Manejo Central de Excepciones](#manejo-central-de-excepciones)
- [Sistema de Monitoreo](#sistema-de-monitoreo)
- [Comando de Health Check](#comando-de-health-check)
- [Tipos de Errores Manejados](#tipos-de-errores-manejados)
- [Logging y Alertas](#logging-y-alertas)
- [Configuraci√≥n y Uso](#configuraci√≥n-y-uso)

## üöÄ Introducci√≥n

El sistema de manejo de errores implementado para la API V2 proporciona una gesti√≥n robusta, comprensiva y profesional de errores, con capacidades avanzadas de monitoreo, logging y alertas autom√°ticas.

### Objetivos principales:
- ‚úÖ **Prevenir errores 500 no controlados**
- ‚úÖ **Logging detallado y contextual**
- ‚úÖ **Monitoreo proactivo de la salud de la API**
- ‚úÖ **Respuestas de error consistentes y √∫tiles**
- ‚úÖ **Alertas autom√°ticas para problemas cr√≠ticos**

## üèóÔ∏è Arquitectura del Sistema

### Flujo de Manejo de Errores

```
Request ‚Üí Middlewares ‚Üí Controller ‚Üí Response
    ‚Üì           ‚Üì           ‚Üì           ‚Üì
Validator ‚Üí Monitor ‚Üí Exception ‚Üí Error Handler
    ‚Üì           ‚Üì           ‚Üì           ‚Üì
   Log    ‚Üí   Alert  ‚Üí   Format ‚Üí    JSON Response
```

### Componentes principales:

1. **Middlewares de Protecci√≥n** - Validaci√≥n y monitoreo en tiempo real
2. **Exception Handler Central** - Manejo unificado en `bootstrap/app.php`
3. **Sistema de Logging** - Registro detallado con contexto
4. **Health Check Command** - Diagn√≥stico completo del sistema
5. **Alertas Autom√°ticas** - Notificaciones proactivas

## üõ°Ô∏è Middlewares Implementados

### 1. ApiResourceValidator

**Ubicaci√≥n:** `app/Http/Middleware/ApiResourceValidator.php`

**Funci√≥n:** Valida la estructura y formato de las requests antes de llegar al controller.

**Validaciones:**
- ‚úÖ Content-Type para POST/PUT/PATCH
- ‚úÖ Accept headers requeridos
- ‚úÖ Par√°metros de paginaci√≥n (per_page: 1-100)
- ‚úÖ Formato de par√°metros de ordenamiento

**Ejemplo de respuesta de error:**
```json
{
  "status": "error",
  "message": "Content-Type debe ser application/json para este tipo de request.",
  "data": {
    "error_code": "INVALID_REQUEST_FORMAT",
    "api_version": "2.0",
    "help": {
      "content_type": "Usa Content-Type: application/json para POST/PUT/PATCH",
      "accept": "Incluye Accept: application/json en los headers"
    }
  }
}
```

### 2. ApiErrorMonitoring

**Ubicaci√≥n:** `app/Http/Middleware/ApiErrorMonitoring.php`

**Funci√≥n:** Monitoreo en tiempo real de errores y rendimiento.

**Caracter√≠sticas:**
- ‚úÖ **Monitoreo de tiempo de respuesta** (alerta si >2 segundos)
- ‚úÖ **Detecci√≥n de patrones de error** (alerta si >10 errores/5min desde misma IP)
- ‚úÖ **Alertas de errores cr√≠ticos** (una vez por hora por tipo de error)
- ‚úÖ **Sanitizaci√≥n de datos sensibles** en logs

**M√©tricas monitoreadas:**
- Tiempo de respuesta por endpoint
- Frecuencia de errores por IP y c√≥digo de estado
- Errores cr√≠ticos √∫nicos con deduplicaci√≥n
- Datos de request (sanitizados)

## üéõÔ∏è Manejo Central de Excepciones

**Ubicaci√≥n:** `bootstrap/app.php` - Secci√≥n `withExceptions`

### Tipos de excepciones manejadas:

#### 1. ThrottleRequestsException (429)
```php
// Rate limiting excedido
{
  "status": "error", 
  "message": "Demasiadas requests. Intenta de nuevo en X segundos.",
  "data": {
    "retry_after": 60,
    "max_attempts": 15
  }
}
```

#### 2. ModelNotFoundException (404)
```php
// Modelo no encontrado
{
  "status": "error",
  "message": "El recurso Ticket solicitado no fue encontrado.",
  "data": {
    "error_code": "RESOURCE_NOT_FOUND",
    "resource_type": "ticket",
    "api_version": "2.0"
  }
}
```

#### 3. ValidationException (422)
```php
// Errores de validaci√≥n
{
  "status": "error",
  "message": "Los datos proporcionados no son v√°lidos.",
  "errors": {
    "title": ["El campo t√≠tulo es obligatorio."]
  },
  "data": {
    "error_code": "VALIDATION_FAILED",
    "api_version": "2.0"
  }
}
```

#### 4. AuthorizationException (403)
```php
// Sin permisos
{
  "status": "error",
  "message": "No tienes permisos para realizar esta acci√≥n.",
  "data": {
    "error_code": "FORBIDDEN",
    "api_version": "2.0"
  }
}
```

#### 5. Errores Gen√©ricos 500
```php
// Modo desarrollo
{
  "status": "error",
  "message": "Error interno del servidor.",
  "data": {
    "error_code": "INTERNAL_SERVER_ERROR",
    "api_version": "2.0",
    "debug_info": {
      "exception": "TypeError",
      "message": "Undefined method...",
      "file": "/path/to/file.php",
      "line": 123
    }
  }
}

// Modo producci√≥n
{
  "status": "error",
  "message": "Ha ocurrido un error interno. Por favor, int√©ntalo de nuevo m√°s tarde.",
  "data": {
    "error_code": "INTERNAL_SERVER_ERROR",
    "api_version": "2.0",
    "error_id": "err_67289abc123",
    "timestamp": "2025-10-30T15:30:00.000000Z",
    "support_contact": "soporte@tudominio.com"
  }
}
```

## üìä Sistema de Monitoreo

### Logging Contextual

Cada error registra:
- **URL y m√©todo** de la request
- **Usuario autenticado** (ID o 'anonymous')
- **IP y User-Agent** del cliente
- **Datos de request** (sanitizados)
- **Stack trace completo**
- **Timestamp preciso**

### Categor√≠as de log:
- **INFO** - Eventos normales (rutas no encontradas, etc.)
- **WARNING** - Problemas menores (acceso denegado, rate limiting)
- **ERROR** - Errores del servidor
- **CRITICAL** - Errores que requieren atenci√≥n inmediata

### Deduplicaci√≥n inteligente:
- Errores cr√≠ticos: 1 alerta por hora por tipo
- Patrones de error: Reset autom√°tico cada 5 minutos
- Rate limiting por IP para evitar spam

## üè• Comando de Health Check

**Comando:** `php artisan api:health-check`

### Verificaciones realizadas:

#### 1. Base de Datos
- ‚úÖ Conectividad
- ‚úÖ Tiempo de respuesta
- ‚úÖ Conteo de registros principales

#### 2. Sistema de Cache
- ‚úÖ Operaciones de lectura/escritura
- ‚úÖ Funcionamiento correcto

#### 3. Autenticaci√≥n
- ‚úÖ Tokens activos en el sistema
- ‚úÖ Estado de Sanctum

#### 4. Endpoints Cr√≠ticos
- ‚úÖ Disponibilidad de rutas principales
- ‚úÖ Tiempo de respuesta de cada endpoint

#### 5. An√°lisis de Logs
- ‚úÖ Errores en la √∫ltima hora
- ‚úÖ Warnings y cr√≠ticos
- ‚úÖ Patrones de problemas

#### 6. Rendimiento
- ‚úÖ Consultas complejas
- ‚úÖ Uso de memoria
- ‚úÖ Tiempo de respuesta

### Ejemplo de salida:

```bash
üè• Iniciando verificaci√≥n de salud de la API...
üìä Resultados de la verificaci√≥n:

‚úÖ Database: healthy (Score: 100%)
   Users: 12
   Tickets: 100
   Response time ms: 25.39

‚úÖ Cache: healthy (Score: 100%)
   Cache test: 1

‚úÖ Authentication: healthy (Score: 100%)
   Total tokens: 5
   Active tokens: 5

‚ö†Ô∏è Api endpoints: degraded (Score: 75%)
   /api/v1: healthy (150ms)
   /api/v2: healthy (80ms)
   
‚úÖ Performance: healthy (Score: 96%)
   Complex query time ms: 1.27
   Memory usage mb: 28

‚úÖ Estado de salud excelente: 94%
```

### Reporte detallado:

```bash
php artisan api:health-check --report
```

Genera un archivo JSON completo en `storage/logs/api_health_report_FECHA.json` con:
- M√©tricas detalladas
- Recomendaciones autom√°ticas
- Hist√≥rico de problemas
- Sugerencias de optimizaci√≥n

## üö® Tipos de Errores Manejados

### Errores de Cliente (4xx)

| C√≥digo | Tipo | Descripci√≥n | Ejemplo |
|--------|------|-------------|---------|
| 400 | Bad Request | Request malformado | Content-Type incorrecto |
| 401 | Unauthorized | Token faltante/inv√°lido | Bearer token requerido |
| 403 | Forbidden | Sin permisos | Acceso denegado por policy |
| 404 | Not Found | Recurso inexistente | Ticket no encontrado |
| 405 | Method Not Allowed | M√©todo incorrecto | POST en ruta GET |
| 422 | Validation Error | Datos inv√°lidos | Campo requerido faltante |
| 429 | Too Many Requests | Rate limit | L√≠mite de requests excedido |

### Errores de Servidor (5xx)

| C√≥digo | Tipo | Descripci√≥n | Manejo |
|--------|------|-------------|--------|
| 500 | Internal Server Error | Error no manejado | Log + alerta cr√≠tica |
| 502 | Bad Gateway | Error de proxy | Monitoreo de infraestructura |
| 503 | Service Unavailable | Servicio no disponible | Health check autom√°tico |
| 504 | Gateway Timeout | Timeout de request | An√°lisis de rendimiento |

## üìù Logging y Alertas

### Estructura de logs:

```json
{
  "level": "ERROR",
  "message": "API Internal Server Error",
  "context": {
    "exception": "TypeError",
    "message": "Call to undefined method...",
    "file": "/app/Http/Controllers/V2/TicketController.php",
    "line": 45,
    "url": "https://api.example.com/api/v2/tickets",
    "method": "GET",
    "user_id": 123,
    "ip": "192.168.1.1",
    "user_agent": "PostmanRuntime/7.28.4",
    "trace": "...",
    "api_version": "2.0",
    "timestamp": "2025-10-30T15:30:00.000000Z"
  }
}
```

### Sistema de alertas:

#### Alertas cr√≠ticas (CRITICAL):
- Errores de base de datos
- Fallos de autenticaci√≥n masivos
- Excepciones no manejadas
- Problemas de memoria

#### Alertas de advertencia (WARNING):
- Respuestas lentas (>2 segundos)
- Patrones de error frecuentes
- Rate limiting activado
- Problemas de autorizaci√≥n

#### Alertas informativas (INFO):
- Nuevos registros de usuario
- Patrones de uso inusuales
- Cambios en configuraci√≥n

## ‚öôÔ∏è Configuraci√≥n y Uso

### 1. Activaci√≥n autom√°tica

El sistema se activa autom√°ticamente al hacer requests a rutas `/api/*`:

```php
// En bootstrap/app.php
$middleware->group('api', [
    \App\Http\Middleware\ApiErrorMonitoring::class,
    \App\Http\Middleware\ApiResourceValidator::class,
]);
```

### 2. Variables de entorno

```env
# Control de debug
APP_DEBUG=false  # true para modo desarrollo

# Logging
LOG_CHANNEL=stack
LOG_LEVEL=info

# Rate limiting
SANCTUM_RATE_LIMIT=15  # requests por minuto para V2
```

### 3. Configuraci√≥n de alertas

En `app/Http/Middleware/ApiErrorMonitoring.php`:

```php
// Configurar l√≠mites
private const SLOW_RESPONSE_THRESHOLD = 2000; // ms
private const ERROR_PATTERN_THRESHOLD = 10;   // errores
private const ALERT_COOLDOWN = 3600;          // segundos
```

### 4. Personalizaci√≥n de respuestas

Modificar en `bootstrap/app.php` la secci√≥n `withExceptions`:

```php
$exceptions->render(function (CustomException $exception, $request) {
    return ApiResponseService::error(
        'Mensaje personalizado',
        500,
        ['custom_data' => 'valor']
    );
});
```

## üîß Troubleshooting

### Problemas comunes:

#### 1. Health check falla en endpoints
```bash
# Verificar que las rutas existen
php artisan route:list --name=api.v2

# Verificar conectividad
curl http://your-domain.test/api/v2/health
```

#### 2. Logs no se generan
```bash
# Verificar permisos
chmod -R 755 storage/logs

# Verificar configuraci√≥n
php artisan config:clear
```

#### 3. Alertas duplicadas
```bash
# Limpiar cache de alertas
php artisan cache:clear
```

### Comandos √∫tiles:

```bash
# Health check completo
php artisan api:health-check --report

# Verificar logs recientes
tail -f storage/logs/laravel.log

# Limpiar logs antiguos
php artisan log:clear

# Verificar estado del cache
php artisan cache:table
```

## üìà M√©tricas y KPIs

### M√©tricas de salud:
- **Uptime de endpoints**: >99.5%
- **Tiempo de respuesta promedio**: <500ms
- **Tasa de errores 5xx**: <1%
- **Cobertura de manejo de errores**: 100%

### Alertas objetivo:
- **Errores cr√≠ticos**: 0 por d√≠a
- **Respuestas lentas**: <5% del total
- **Rate limiting**: <2% de requests

---

## üéØ Resumen

El sistema implementado proporciona:

‚úÖ **Manejo robusto** de todos los tipos de errores  
‚úÖ **Logging contextual** y detallado  
‚úÖ **Monitoreo proactivo** en tiempo real  
‚úÖ **Alertas inteligentes** con deduplicaci√≥n  
‚úÖ **Health checks** automatizados  
‚úÖ **Respuestas consistentes** en formato JSON  
‚úÖ **Separaci√≥n clara** entre modo desarrollo y producci√≥n  
‚úÖ **Documentaci√≥n completa** y ejemplos pr√°cticos  

El sistema est√° preparado para **producci√≥n** y proporciona las herramientas necesarias para mantener una API robusta, monitoreada y confiable.